# Database Migrations Playbook

> **RusingAcademy Ecosystem — Operational Guide for Database Schema Management**
>
> Version 1.0 | Sprint Y1-W1-S02 | February 2026

---

## Table of Contents

1. [Overview](#overview)
2. [Architecture](#architecture)
3. [Daily Workflow](#daily-workflow)
4. [Scripts Reference](#scripts-reference)
5. [CI Integration](#ci-integration)
6. [Emergency Procedures](#emergency-procedures)
7. [TiDB-Specific Notes](#tidb-specific-notes)
8. [Troubleshooting](#troubleshooting)

---

## Overview

The RusingAcademy ecosystem uses **Drizzle ORM** with the **MySQL dialect** to manage a schema of 164+ tables. Migrations are generated by `drizzle-kit` and tracked via a JSON journal at `drizzle/meta/_journal.json`. The database is hosted on **TiDB** (MySQL-compatible).

This playbook defines the standard operating procedures for all database schema changes, from development through production deployment.

### Principles

1. **Forward-only migrations** — Drizzle does not support rollback/down migrations. Compensating migrations are used instead.
2. **Backup before migrate** — Every production migration is preceded by an automated schema backup.
3. **Validate before apply** — The CI pipeline runs `scripts/db/validate.ts` on every PR to catch inconsistencies early.
4. **Immutable migration files** — Once committed, migration SQL files must never be edited. Create a new migration instead.

---

## Architecture

```
drizzle/
├── schema.ts              # Source of truth (164 tables, ~210KB)
├── rbac-schema.ts         # RBAC-specific schema extensions
├── sle-schema.ts          # SLE exam simulation schema
├── relations.ts           # Table relationships
├── 0000_*.sql             # Migration files (auto-generated)
├── ...
├── 0060_*.sql
└── meta/
    ├── _journal.json      # Migration journal (tracks applied migrations)
    └── 0000_snapshot.json # Schema snapshots per migration
    └── ...

scripts/db/
├── migrate.ts             # Migration wrapper (backup → generate → apply → validate)
├── backup.ts              # Database backup (mysqldump)
├── restore.ts             # Database restore from backup
└── validate.ts            # Migration consistency validator (CI-ready)

backups/                   # Auto-created, holds timestamped SQL dumps
├── .gitkeep
└── backup_*.sql.gz        # Compressed backups (auto-cleaned, keeps last 10)

drizzle.config.ts          # Drizzle Kit configuration
```

---

## Daily Workflow

### Adding a New Table or Column

```bash
# 1. Edit the schema file
#    → drizzle/schema.ts (or rbac-schema.ts / sle-schema.ts)

# 2. Generate the migration
npm run db:generate

# 3. Review the generated SQL file
#    → Check drizzle/00XX_*.sql for correctness

# 4. Validate consistency
npm run db:validate

# 5. Apply to local/staging database
npm run db:migrate

# 6. Commit everything (schema + migration + journal + snapshot)
git add drizzle/
git commit -m "feat(db): add XYZ table/column"
```

### Modifying an Existing Column

```bash
# 1. Modify the column definition in schema.ts
# 2. Generate migration: npm run db:generate
# 3. IMPORTANT: Review the generated SQL carefully
#    → Drizzle may generate DROP + CREATE instead of ALTER
#    → For data-preserving changes, create a manual migration
# 4. Validate: npm run db:validate
# 5. Apply: npm run db:migrate
```

### Creating a Manual (Data) Migration

For data migrations that cannot be auto-generated (e.g., backfilling a new column):

```bash
# 1. Create a new SQL file with the next sequence number
#    → drizzle/0061_manual_description.sql

# 2. Write your SQL statements
#    → Use IF EXISTS / IF NOT EXISTS for safety

# 3. Add the entry to drizzle/meta/_journal.json manually:
#    {
#      "idx": 61,
#      "version": "7",
#      "when": 1708000000000,
#      "tag": "0061_manual_description",
#      "breakpoints": true
#    }

# 4. Validate: npm run db:validate
# 5. Apply: npm run db:migrate
```

---

## Scripts Reference

### `npm run db:migrate`

Full migration workflow with safety hooks.

```bash
npm run db:migrate                    # Generate + apply with pre-backup
npm run db:migrate -- --no-backup     # Skip backup (dev only)
npm run db:migrate -- --dry-run       # Preview without changes
npm run db:migrate -- --generate-only # Generate SQL only, don't apply
```

### `npm run db:backup`

Create a timestamped database dump.

```bash
npm run db:backup                          # Full backup (schema + data)
npm run db:backup -- --schema-only         # Schema only (faster)
npm run db:backup -- --tables=users,courses # Specific tables
npm run db:backup -- --no-compress         # Uncompressed SQL
```

Backups are saved to `backups/` with auto-cleanup (keeps last 10).

### `npm run db:restore`

Restore from a backup file.

```bash
npm run db:restore backups/backup_2026-02-15T12-00-00_full.sql.gz
npm run db:restore backups/backup_2026-02-15T12-00-00_full.sql.gz --force  # Skip confirmation
```

### `npm run db:validate`

Validate migration consistency (used in CI).

```bash
npm run db:validate
```

Checks performed:
- Journal file exists and is valid JSON
- Schema file exists with tables defined
- Meta snapshots exist
- Journal sequence is sequential (0, 1, 2, ...)
- All journal entries have corresponding SQL files
- No orphaned SQL files outside journal
- No duplicate migration prefixes

### `npm run db:generate`

Generate new migration files from schema changes (alias for `drizzle-kit generate`).

```bash
npm run db:generate
```

---

## CI Integration

The CI pipeline (`.github/workflows/ci.yml`) includes a migration validation step:

```yaml
- name: Validate DB Migrations
  run: npx tsx scripts/db/validate.ts
```

This runs on every PR and blocks merging if:
- Migration files are missing for journal entries
- Journal sequence is broken
- Schema file is missing or empty

**Quality Gate**: Migration validation must PASS before any PR can be merged.

---

## Emergency Procedures

### Scenario: Migration Failed in Production

```bash
# 1. Check the error in Railway logs
railway logs --service <service-id>

# 2. If the migration partially applied, create a compensating migration:
#    → Write SQL to undo the partial changes
#    → Add as next migration file

# 3. If data was corrupted, restore from backup:
npm run db:restore backups/<latest-backup>.sql.gz --force

# 4. Fix the migration, re-validate, and re-deploy
npm run db:validate
```

### Scenario: Duplicate Migration Prefixes

```bash
# Current known duplicates: 0055, 0057
# These are tracked in the journal and should not cause issues
# If they do, consolidate:

# 1. Merge the two SQL files into one
# 2. Update _journal.json to remove the duplicate entry
# 3. Rename files to have unique prefixes
# 4. Validate: npm run db:validate
```

### Scenario: Schema Drift (DB differs from migrations)

```bash
# 1. Generate a fresh migration to capture the drift
npm run db:generate

# 2. Review the generated SQL carefully
# 3. If the drift is intentional, commit the migration
# 4. If not, investigate what caused the drift
```

---

## TiDB-Specific Notes

1. **Foreign Keys**: TiDB has limited foreign key support. The schema uses application-level constraints instead of database-level foreign keys in most cases.

2. **Online DDL**: Large table alterations (e.g., adding columns to tables with millions of rows) should use `ALGORITHM=INPLACE` when possible. TiDB handles most DDL operations online.

3. **AUTO_INCREMENT**: TiDB's auto-increment behavior differs from MySQL. IDs may not be strictly sequential. Use `AUTO_RANDOM` for high-throughput tables if needed.

4. **Backup**: `mysqldump` works with TiDB. Use `--single-transaction` for consistent snapshots (already included in the backup script).

5. **Connection Limits**: TiDB Serverless has connection limits. The backup script uses a single connection to avoid exhausting the pool.

---

## Troubleshooting

### "No changes detected" when running db:generate

- Ensure you saved the schema file
- Check that `drizzle.config.ts` points to the correct schema file
- Run `npx drizzle-kit check` to verify the schema is parseable

### "Migration already applied" error

- The migration journal tracks which migrations have been applied
- If you need to re-apply, you must either:
  - Create a new migration with the same changes
  - Manually update the `__drizzle_migrations` table in the database

### "Cannot connect to database" during migration

- Verify `DATABASE_URL` is set correctly
- Check that the database is accessible from your network
- For TiDB, ensure SSL is enabled in the connection string

### Build fails with "Cannot find module 'drizzle/schema'"

- The schema is at `drizzle/schema.ts`, not `shared/schema.ts`
- Check `drizzle.config.ts` for the correct path
- Ensure the schema file compiles without TypeScript errors
